<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil Docente - Plataforma de Gestión</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        
    /* --- 1. VARIABLES GLOBALES (MICROSOFT INSPIRED REFINADO) --- */
    :root {
        --ms-blue: #0078D4; /* Azul Primario de Microsoft */
        --ms-blue-hover: #005a9e; /* Azul más oscuro para hover */
        --ms-blue-light: #eff6fc; /* Fondo claro para items activos/hover */
        --ms-gray-light: #f3f2f1; /* Color de fondo principal (cuerpo) */
        --ms-gray-border: #edebe9; /* Color de borde y separadores */
        --ms-text-dark: #323130; /* Texto oscuro principal */
        --ms-text-light: #605e5c; /* Texto secundario (gris) */
        --ms-red: #D13438; /* Rojo - Usado para alertar/admin */
        --card-background: #ffffff;
        /* Sombra mejorada para un efecto más flotante */
        --shadow-elevated: 0 8px 16px rgba(0, 0, 0, 0.1); 
    }

    /* --- 2. BASE: BODY, TIPOGRAFÍA Y ENLACES --- */
    body { 
        font-family: 'Poppins', sans-serif; 
        margin: 0; 
        background-color: var(--ms-gray-light); 
        color: var(--ms-text-dark); 
        line-height: 1.6;
        font-size: 15px; 
        min-height: 100vh;
        display: flex; 
        flex-direction: column;
    }
    
    a {
        text-decoration: none;
        color: var(--ms-blue);
        transition: color 0.2s;
    }
    a:hover {
        color: var(--ms-blue-hover);
    }
    
    .main-layout { 
        display: flex; 
        flex-grow: 1; 
    }

    /* --- 3. LAYOUT PRINCIPAL (HEADER) --- */
    
    .header { 
        background-color: var(--card-background);
        height: 60px; 
        padding: 0 25px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        border-bottom: 1px solid var(--ms-gray-border);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        flex-shrink: 0;
    }
    .header h3 { 
        margin: 0; 
        font-size: 1.2em; 
        font-weight: 700; 
        color: var(--ms-blue); 
    }
    .user-menu { display: flex; align-items: center; gap: 10px; }
    
    .profile-info { 
        padding: 8px 10px; border-radius: 4px;
        transition: background-color 0.2s; 
        text-align: right;
    }
    .profile-info:hover { background-color: var(--ms-gray-border); }
    .profile-text { display: block; font-weight: 400; color: var(--ms-text-light); font-size: 0.8em; line-height: 1;}
    .profile-name { font-weight: 600; color: var(--ms-text-dark); font-size: 0.95em; line-height: 1.2;}
    
    .user-menu a#logoutButton, .user-menu a.admin {
        font-weight: 500; padding: 8px 12px; border-radius: 4px;
        color: var(--ms-text-dark);
        display: flex; align-items: center; gap: 5px;
        white-space: nowrap; 
    }
    .user-menu a#logoutButton:hover, .user-menu a.admin:hover {
        background-color: var(--ms-gray-border);
    }
    
    /* --- 4. CONTENIDO PRINCIPAL --- */
    
    .content-area {
        flex-grow: 1;
        padding: 40px;
        overflow-y: auto;
    }
    
    .profile-card {
        background-color: var(--card-background);
        padding: 40px;
        border-radius: 8px;
        box-shadow: var(--shadow-elevated); 
        border: 1px solid var(--ms-gray-border);
        margin: 0 auto;
        max-width: 900px; 
    }

    .section-title-profile { 
        color: var(--ms-blue);
        font-size: 1.6em;
        font-weight: 700;
        margin-top: 30px;
        margin-bottom: 20px;
        border-bottom: 3px solid var(--ms-blue-light); 
        padding-bottom: 10px;
        display: flex; align-items: center;
    }
    .section-title-profile i { margin-right: 10px; color: var(--ms-blue); font-size: 1.1em; }
    .section-title-profile:first-child { margin-top: 0; }

    /* Detalle de Docente (Card interior) */
    .profile-details {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 40px;
        padding: 20px;
        border: 1px solid var(--ms-gray-border);
        border-radius: 6px;
        background-color: var(--ms-blue-light); 
    }
    .detail-item {
        display: flex;
        align-items: center;
        line-height: 1.4;
        font-size: 1em;
        color: var(--ms-text-dark);
    }
    .detail-item i { margin-right: 10px; color: var(--ms-blue); font-size: 1.1em; }
    .detail-item strong {
        display: inline-block;
        width: 100px; 
        font-weight: 600;
        color: var(--ms-text-dark);
        margin-right: 5px;
    }
    
    /* Cursos Agrupados (Listas) */
    .course-group {
        margin-bottom: 30px;
        border-left: 5px solid var(--ms-blue); 
        padding: 15px 0 15px 0; 
        background-color: var(--card-background);
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .course-group-title {
        font-size: 1.2em;
        font-weight: 700;
        color: var(--ms-text-dark);
        margin-bottom: 10px;
        padding: 0 20px;
        display: flex; align-items: center; gap: 8px;
    }
    
    .course-list-main {
        list-style: none;
        padding: 0 20px;
        margin: 0;
    }

    .course-list-main li {
        padding: 12px 0;
        border-bottom: 1px solid var(--ms-gray-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.95em;
        font-weight: 500;
        flex-wrap: wrap; 
        gap: 10px; 
    }
    .course-list-main li:last-child { border-bottom: none; padding-bottom: 0; }

    /* Estilo de Botón Primario (Aplicado a Registrar Notas y Botones Admin) */
    .btn-primary {
        background-color: var(--ms-blue);
        color: white;
        padding: 10px 20px; 
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9em; 
        font-weight: 600;
        transition: background-color 0.2s, transform 0.1s;
        display: block;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .btn-primary:hover {
        background-color: var(--ms-blue-hover);
        transform: translateY(-1px);
    }

    .course-list-main a {
        /* Estilos específicos para los botones dentro de la lista de cursos */
        font-weight: 600;
        padding: 8px 15px; /* Ajuste para que se vea mejor en la lista */
        background-color: var(--ms-blue);
        color: white;
        border-radius: 4px;
        font-size: 0.9em;
    }

    /* --- 5. OPCIONES DE ADMINISTRACIÓN --- */

    .admin-options {
        margin-top: 40px; 
        border-top: 1px solid var(--ms-gray-border);
        padding-top: 20px;
    }
    .admin-buttons-container {
        display: flex;
        gap: 10px;
        flex-wrap: wrap; 
    }
    /* Estilos específicos para los botones dentro del contenedor de administración */
    .admin-buttons-container .btn-primary {
        width: auto;
        margin-top: 0;
        padding: 12px 20px; /* Un poco más grandes que los de la lista de cursos */
        display: inline-block; /* Permite que estén en línea con el flexbox */
        max-width: 300px;
        white-space: nowrap; /* Evita que el texto del botón se rompa */
    }


    /* --- 6. MEDIA QUERY: VISTA DE ESCRITORIO (>= 768px) --- */
    @media (min-width: 768px) {
        .profile-details {
            grid-template-columns: repeat(2, 1fr);
        }
        .detail-item strong {
            width: 100px; 
        }
        
        .course-list-main li {
            flex-wrap: nowrap; 
            gap: 0;
        }
        
        .admin-options .btn-primary {
            width: auto;
            margin: 10px 0;
        }
    }

</style>
</head>
<body>

    <div class="header">
        <h3><i class="fas fa-school"></i> Plataforma Docente</h3>
        <div class="user-menu">
            
            <div class="profile-info">
                <span class="profile-text">Bienvenido(a):</span>
                <span id="welcomeMessage" class="profile-name"></span>
            </div>
            
            <a href="admin-registro.html" id="adminLink" class="admin" style="display:none;" title="Registrar Nuevo Usuario"><i class="fas fa-user-shield"></i> Registrar Usuario</a>
            
            <a href="#" id="logoutButton" title="Cerrar sesión de forma segura"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a>
        </div>
    </div>

    <div class="main-layout">
        <div class="content-area" id="main-content">
            
            <div class="profile-card">
                
                <h2 class="section-title-profile"><i class="fas fa-id-card"></i> Información del Docente</h2>
                
                <div class="profile-details">
                    <div class="detail-item">
                        <i class="fas fa-user"></i>
                        <strong>Nombre:</strong> <span id="profileName">Cargando...</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-envelope"></i>
                        <strong>Correo:</strong> <span id="profileEmail">Cargando...</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-briefcase"></i>
                        <strong>Rol:</strong> <span id="profileRole">Cargando...</span>
                    </div>
                    <div class="detail-item">
                      <i class="fas fa-file-alt">
                        </i> <a href="https://script.google.com/macros/s/AKfycbzj0UkBbaAGYxTNk8PY04ddAfhPQ5mtqd_5Cm8BJGpGpnfl733kqh_1xBV_ZzyBLHNC_g/exec" target="_blank" title="Generar reporte de notas en una nueva pestaña"> Generar Reporte de Notas</a>
                    </div>
                </div>

                <h2 class="section-title-profile"><i class="fas fa-book-open"></i> Cursos Asignados</h2>
                <div id="courseContentArea">
                    <p class="loading-message" style="color:var(--ms-text-light); font-style: italic; padding: 10px 0;">Cargando cursos asignados...</p>
                </div>
                
                <div id="adminLinksContainer" class="admin-options" style="display: none;">
                    <h2 class="section-title-profile" style="color: var(--ms-red); border-bottom-color: var(--ms-red);"><i class="fas fa-user-cog" style="color: var(--ms-red);"></i> Opciones de Administración</h2>
                    <p style="margin-bottom: 15px; color: var(--ms-text-dark);">Desde aquí puede gestionar las cuentas de usuario, los enlaces y las asignaciones.</p>
                    
                    <div class="admin-buttons-container">
                        <a href="admin-registro.html" class="btn-primary">Registrar Nuevo Usuario</a>
                        <a href="admin-cursos.html" class="btn-primary">Gestionar Enlaces</a>
                        <a href="admin-usuarios.html" class="btn-primary">Asignar Cursos a Docentes</a> 
                        
                        <a href="admin-toggle-courses.html" class="btn-primary" style="background-color: #0078D4;">Habilitar/Deshabilitar Cursos</a>
                        
                        <a href="https://script.google.com/macros/s/AKfycbzlQPMViJCojNtCE32deDLaNn_Xmy3r9rJfadkH4lPpsjUpleWx7bxrSmAFJMgkWRYd/exec" target="_blank" class="btn-primary">Traslado de Estudiantes</a>
                        <a href="https://script.google.com/macros/s/AKfycbz_IXc-lFh4EX-UoShnDjxhGEWBq-SdR_LBS6zsXvjieiWk_vxc_PmASjj4d0yYuuzl/exec" target="_blank" class="btn-primary">Registro de Estudiantes</a>
                        <a href="https://script.google.com/macros/s/AKfycbxsTCW7CXdTsM9sGI75vaFFOIKaDx3EaT6S-7kUzasaxLmZmbArZv-KiDkCH-rKH8_F6A/exec" target="_blank" class="btn-primary">Nóminas Para Notas</a>
                        <a href="https://script.google.com/macros/s/AKfycbz2NyAsmQjVhAnRCJSMNqBFhNnsmcInLdh8veiAXuGUdz1NE5CMZ0q4xMBilDGhoHM/exec" target="_blank" class="btn-primary">Nóminas por Grado y Sección</a> 
                    </div>
                </div>
                
            </div>

        </div>
    </div>
    
    <script>
    // *** 1. CONSTANTES DE CONFIGURACIÓN ***
    // URL del endpoint de perfil en Render
    const API_URL_PROFILE = 'https://sistema-notas-api-u32a.onrender.com/api/auth/profile'; 
    // URL del endpoint de cursos en Render
    const API_URL_COURSES = 'https://sistema-notas-api-u32a.onrender.com/api/courses'; 

    let coursesData = []; 
    
    // Función de ayuda para generar la estructura de la lista de cursos (IMPLEMENTACIÓN BÁSICA)
    const generateCourseStructure = (courses, coursesContainer) => {
        // Esta función no se usa directamente aquí, pero se mantiene para compatibilidad
        console.log("Course structure generated:", courses);
    };

    /**
     * Genera la lista de cursos asignados en el HTML.
     * @param {Array<string>} assignedCourses - IDs de los cursos asignados al usuario.
     * @param {Object} allCourses - Objeto que contiene todos los datos de los cursos por año/sección.
     */
    const generateProfileCourseList = (assignedCourses, allCourses) => {
        const coursesContainer = document.getElementById('courseContentArea');
        coursesContainer.innerHTML = ''; // Limpiar el área

        if (!assignedCourses || assignedCourses.length === 0) {
            coursesContainer.innerHTML = '<p style="color:var(--ms-text-light); font-style: italic; padding: 10px 20px;">No tiene cursos asignados.</p>';
            return;
        }

        const groupedCourses = {};

        assignedCourses.forEach(courseId => {
            // Recorrer la estructura de cursos para encontrar la información
            for (const yearKey in allCourses) {
                const yearGroup = allCourses[yearKey];
                for (const sectionKey in yearGroup.sections) {
                    const section = yearGroup.sections[sectionKey];
                    
                    if (section.id === courseId) {
                        const groupName = yearGroup.name;
                        if (!groupedCourses[groupName]) {
                            groupedCourses[groupName] = [];
                        }
                        groupedCourses[groupName].push({
                            name: section.name,
                            url: section.url || '#',
                            details: `(${yearKey} / ${sectionKey})`
                        });
                        return;
                    }
                }
            }
        });

        // Crear el HTML basado en la agrupación
        for (const groupName in groupedCourses) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'course-group';
            
            const title = document.createElement('div');
            title.className = 'course-group-title';
            title.innerHTML = `<i class="fas fa-folder-open"></i> ${groupName}`;
            groupDiv.appendChild(title);
            
            const ul = document.createElement('ul');
            ul.className = 'course-list-main';
            
            groupedCourses[groupName].forEach(course => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${course.name} <span style="font-size:0.8em; color: var(--ms-text-light);">${course.details}</span></span>
                    <a href="${course.url}" target="_blank" class="btn-primary" title="Abrir planilla de notas"><i class="fas fa-external-link-alt"></i> Registrar Notas</a>
                `;
                ul.appendChild(li);
            });
            
            groupDiv.appendChild(ul);
            coursesContainer.appendChild(groupDiv);
        }

        if (Object.keys(groupedCourses).length === 0) {
             coursesContainer.innerHTML = '<p style="color:var(--ms-text-dark); font-style: italic; padding: 10px 20px;">Cursos asignados no encontrados en el catálogo.</p>';
        }
    };


    // Función principal para obtener datos del perfil y cursos
    async function fetchProfileData() {
        const token = localStorage.getItem('token');
        const adminLinksContainer = document.getElementById('adminLinksContainer');
        const adminLinkHeader = document.getElementById('adminLink');
        const welcomeMessage = document.getElementById('welcomeMessage');

        if (!token) {
            alert("No hay sesión activa. Redirigiendo al login.");
            window.location.href = "index.html";
            return;
        }

        try {
            // 1. Obtener datos del Perfil (Usuario)
            const profileResponse = await fetch(API_URL_PROFILE, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
            });
            
            // Si falla la autenticación (token inválido o expirado)
            if (profileResponse.status === 401) {
                // Aquí usamos la lógica de error que solicitaste
                throw new Error("Token fallido o expirado (401)");
            }

            if (!profileResponse.ok) {
                const errorData = await profileResponse.json();
                throw new Error(errorData.message || 'Error al obtener datos del perfil.');
            }
            
            const profileData = await profileResponse.json();
            
            // 2. Obtener la lista completa de Cursos (Catálogo)
            const coursesResponse = await fetch(API_URL_COURSES, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}` 
                }
            });

            if (!coursesResponse.ok) {
                 throw new Error('Error al obtener la lista de cursos completa.');
            }
            
            coursesData = await coursesResponse.json(); 

            // 3. Rellenar Información del Perfil
            document.getElementById('profileName').textContent = profileData.name;
            document.getElementById('profileEmail').textContent = profileData.email;
            document.getElementById('profileRole').textContent = profileData.role.toUpperCase();
            welcomeMessage.textContent = profileData.name.split(' ')[0]; // Muestra solo el primer nombre
            
            // 4. Mostrar enlaces de Admin si es necesario
            if (profileData.role === 'admin') {
                if(adminLinksContainer) adminLinksContainer.style.display = 'block';
                if(adminLinkHeader) adminLinkHeader.style.display = 'inline-block';
            } else {
                if(adminLinksContainer) adminLinksContainer.style.display = 'none';
                if(adminLinkHeader) adminLinkHeader.style.display = 'none';
            }
            
            // 5. Generar lista de Cursos Asignados
            const assignedCourses = profileData.courses || [];
            generateProfileCourseList(assignedCourses, coursesData);

        } catch (error) {
            console.error('Error al cargar perfil:', error);
            // Si el error es un 401 (token fallido), forzamos el cierre de sesión.
            alert("Sesión expirada o error de autenticación. Redirigiendo al login.");
            localStorage.clear();
            window.location.href = "index.html"; 
        }
    }


    // *** 3. EVENT LISTENERS Y LÓGICA DE SESIÓN ***
    document.addEventListener('DOMContentLoaded', () => {
        
        fetchProfileData();

        // Cierre de Sesión (Función global de Logout)
        document.getElementById('logoutButton').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = "index.html"; // Redirigir al login principal
        });
    });
</script>
</body>
</html>